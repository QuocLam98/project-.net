@{
    Layout = null;
}

<style>
    .b-tl {
        border-radius: 5px 0 0 0;
    }

    .b-tr {
        border-radius: 0 5px 0 0;
    }

    .b-bl {
        border-radius: 0 0 0 5px;
    }

    .b-br {
        border-radius: 0 0 5px 0;
    }

    .col-4 {
        background-color: #1470F5;
        color: white;
        font-family: Lexend;
        font-size: 14px !important;
        font-style: normal;
        font-weight: 600;
        line-height: normal;
        padding: 6px;
    }

    .col-8 {
        background-color: #1470F5;
        color: white;
        font-family: Lexend;
        font-size: 14px !important;
        font-style: normal;
        font-weight: 600;
        line-height: normal;
        padding: 6px;
    }

    b, h3 {
        font-family: Lexend;
        font-style: normal;
        font-weight: 600;
        line-height: normal;
    }

    @@media (min-width: 768px) {
        .container, .container-md, .container-sm {
            max-width: 1200px !important;
        }
    }
</style>
<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    @*<script src="~/happys/js/page/consultant.js"></script>*@
    <link href="~/happys/css/rating/star-rating-svg.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script>
        var systemURL = window.origin + "/";
        var accountId = @ViewBag.accountId;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</head>

<body class="container">
    <div class="card consultant" style="margin: 8px;">
        <div class="text-center">
            <b style="font-size: x-large;">PHIẾU ĐÁNH GIÁ TƯ VẤN</b>
            <h6 id="note" class="d-none">(Thông tin đang được cán bộ tư vấn cập nhật)</h6>
        </div>
        <div style="margin-bottom: 16px; margin-left: 8px;">

            <label style="margin-bottom: 16px">
                <b>
                    1.  	Thông tin cá nhân [phần này lấy tự động từ hồ sơ của học sinh]
                </b>
            </label>
            <div class="d-flex flex-column">
                <div class="row w-100" style="margin: 8px;">
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col b-tl">
                            <b>Họ và tên</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col b-tr">
                            <b id="full-name"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col back-color">
                            <b>Ngày tháng năm sinh</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col back-color">
                            <b id="dob"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Giới tính (Xác nhận khi sinh)</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="gender"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Dân tộc – Tôn giáo</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="religiousNation"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Trình độ văn hoá</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="culturalLevel"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Số điện thoại</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="phone-number"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Địa chỉ</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="address-detail"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Thời gian tham vấn</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="consultingTime"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Hình thức tư vấn</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="booking-type"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-bottom border-light-subtle padding-col b-bl">
                            <b>Chuyên gia thực hiện</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-bottom border-light-subtle padding-col b-br">
                            <b id="conselor-name"></b>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px; margin-left: 8px;">
            <label style="margin-bottom: 16px">
                <b>
                    2.  	Phần chuyên môn
                </b>
            </label>
            <div class="d-flex flex-column ">
                <div class="row w-100" style="margin: 8px; width: 99%">
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col b-tl">
                            <b>Lý do đến tham vấn</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col b-tr">
                            <b id="booking-reason"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Triệu chứng, biểu hiện thực thể</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="symptom-user"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col">
                            <b>Các mối quan hệ gia đình và xã hội</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col">
                            <b id="religiorelationship"></b>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle border-bottom padding-col b-bl">
                            <b>Tiền sử bản thân và gia đình</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle border-bottom padding-col b-br">
                            <b id="history"></b>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px; margin-left: 8px;">
            <label style="margin-bottom: 16px">
                <b>
                    3.  	Kết quả đánh giá sơ bộ
                </b>
            </label>
            <div class="d-flex flex-column ">
                <div class="row w-100" style="margin: 8px; width: 99%">
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle border-bottom padding-col" style="border-radius: 5px 0 0 5px">
                            <b>Kết quả đánh giá sơ bộ</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle border-bottom padding-col" style="border-radius:0 5px 5px 0">
                            <b id="assessmentResult"></b>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px; margin-left: 8px">
            <label style="margin-bottom: 16px">
                <b>
                    4.  	Mục tiêu tư vấn
                </b>
            </label>
            <div class="d-flex flex-column ">
                <div class="row w-100" style="margin: 8px; width: 99%">
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle border-bottom padding-col" style="border-radius: 5px 0 0 5px">
                            <b>Mục tiêu tư vấn</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle border-bottom padding-col" style="border-radius:0 5px 5px 0">
                            <b id="target"></b>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px; margin-left: 8px;">
            <label style="margin-bottom: 16px">
                <b>
                    5.  	Kết quả tư vấn
                </b>
            </label>
            <div class="d-flex flex-column ">
                <div class="row w-100" style="margin: 8px; width: 99%">
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle border-bottom padding-col" style="border-radius: 5px 0 0 5px">
                            <b>Kết quả tư vấn</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle border-bottom padding-col" style="border-radius:0 5px 5px 0">
                            <b id="consultingResults"></b>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px; margin-left: 8px;">
            <label style="margin-bottom: 16px">
                <b>
                    6.  	Kế hoạch tiếp theo
                </b>
            </label>
            <div class="d-flex flex-column ">
                <div class="row w-100" style="margin: 8px; width: 99%">
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle border-bottom padding-col" style="border-radius: 5px 0 0 5px">
                            <b>Kế hoạch tiếp theo</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle border-bottom padding-col" style="border-radius:0 5px 5px 0">
                            <b id="consultingPlan"></b>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px; margin-left: 8px;">
            <label style="margin-bottom: 16px">
                <b>
                    7.  	Đánh giá của học sinh sau buổi tư vấn (phần này hiện cho học sinh đánh giá)
                </b>
            </label>
            <div class="d-flex flex-column ">
                <div class="row w-100" style="margin: 8px; width: 99%">
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle padding-col b-tl" style="background-color: #F04A7C !important">
                            <b>Chấm sao</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle padding-col b-tr" style="padding-bottom: 6px; background-color: #F04A7C !important">
                            <div class="my-rating" readOnly></div>
                        </div>
                    </div>
                    <div class="col-12 row">
                        <div class="col-4 border-top border-start border-light-subtle border-bottom padding-col b-bl" style="background-color: #F04A7C !important">
                            <b>Nhận xét:</b>
                        </div>
                        <div class="col-8 border-top border-start border-end border-light-subtle border-bottom padding-col b-br" style="background-color: #F04A7C !important">
                            <b id="review"></b>
                        </div>
                        @*<textarea type="text" class="review col-8 border-top border-start border-end border-bottom border-light-subtle padding-col"
                        id="review" data-kt-autosize="true"></textarea>*@
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center" style="margin-bottom: 16px;">
            <button type="button" class="btn btn-primary btn-lg" id="btnSave">Xác Nhận</button>
        </div>
    </div>
    <div class="modal fade" id="modal-id">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title text-center">Đánh giá của bạn sau buổi tư vấn</h3>

                    <!--begin::Close-->
                    <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                        <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                    </div>
                    <!--end::Close-->
                </div>
                <div class="modal-body">
                    <div class="d-flex flex-column ">
                        <div class="row w-100" style="margin: 8px;">
                            <div class="w-100 row">
                                <div class="col-4 border-top border-start border-light-subtle padding-col" style="background-color: white; color: black">
                                    <b>Chấm sao</b>
                                </div>
                                <div class="col-8 border-top border-start border-end border-light-subtle padding-col" style="padding-bottom: 6px; background-color: white; color: black">
                                    <div class="rating"></div>
                                </div>
                            </div>
                            <div class="w-100 row">
                                <div class="col-4 border-top border-start border-light-subtle border-bottom padding-col" style="background-color: white; color: black">
                                    <b>Nhận xét:</b>
                                </div>
                                <textarea type="text"
                                          class="review col-8 border-top border-start border-end border-bottom border-light-subtle padding-col" style="background-color: white; color: black"
                                          id="reviewNote"
                                          data-kt-autosize="true"
                                          placeholder="Vui lòng điền đánh giá của bạn về buổi tư vấn"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer sticky-action justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="btnUpdateItem">Lưu</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script src="~/happys/js/rating/rate.js"></script>
<script>
    var star = 0;
    var ratingStar = 0;
    $(document).ready(function() {
        $(".caption").addClass("d-none");
        var url = new URL(window.location.href);
        var pathUrl = url.pathname;
        var urlArray = pathUrl.split('/')
        var bookingId = urlArray[urlArray.length - 1];
        getDetailConsultantByBookingId(bookingId);
        $('.my-rating').starRating('setReadOnly', true);
        $('#btnSave').click(function() {
            $("#modal-id").modal('show');
        });
        $('#btnUpdateItem').click(function() {
            updateItem();
        });
    });
    $(".my-rating").starRating({
        disableAfterRate: false,
        useGradient: false,
        callback: function(currentRating) {
            star = currentRating
        },
        starSize: 25,
        strokeWidth: 3,
        initialRating: 0,
        starGradient: {
            start: '#AABBCC',
            end: '#002233'
        },
    });
    $(".rating").starRating({
        disableAfterRate: false,
        useGradient: false,
        callback: function(currentRating) {
            ratingStar = currentRating
        },
        starSize: 25,
        strokeWidth: 3,
        initialRating: 0,
        starGradient: {
            start: '#AABBCC',
            end: '#002233'
        },
    });

    async function updateItem() {
        var updatingObj = {
            'id': dataConsultant.id,
            'accountId': dataConsultant.accountId,
            'counselorsId': dataConsultant.counselorId,
            'reason': dataConsultant.reason,
            'symptom': dataConsultant.symptom,
            'religiorelationship': dataConsultant.religiorelationship,
            'history': dataConsultant.history,
            'assessmentResult': dataConsultant.assessmentResult,
            'target': dataConsultant.target,
            'consultingResults': dataConsultant.consultingResults,
            'consultingPlan': dataConsultant.consultingPlan,
            'religiousNation': dataConsultant.religiousNation,
            'culturalLevel': dataConsultant.culturalLevel,
            'implementation': dataConsultant.implementation,
            'bookingId': dataConsultant.bookingId,
            'consultingTime': dataConsultant.consultingTime,
            'form': dataConsultant.form,
            'review': $("#reviewNote").val(),
            'rating': ratingStar,
            'createdTime': dataConsultant.createdTime,
        }

        Swal.fire({
            title: 'Phiếu đánh giá',
            html: "Bạn có chắc chắn muốn xác nhận phiếu đánh giá ?",
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#443',
            cancelButtonText: 'Hủy',
            confirmButtonText: 'Đồng ý',
        }).then((result) => {
            if (result.value) {
                $.ajax({
                    url: systemURL + "consultant/api/update",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(updatingObj),
                    success: function(responseData) {
                        // debugger;
                        if (responseData.status == 200 && responseData.message === "SUCCESS") {
                            Swal.fire(
                                'Thành Công!',
                                'Đã xác nhận phiếu đánh giá thành công',
                                'success'
                            );
                            $("#modal-id").modal('hide');
                            location.reload(true);
                        }
                    },
                    error: function(e) {
                        //console.log(e.message);
                        Swal.fire(
                            'Lỗi!',
                            'Đã xảy ra lỗi, vui lòng thử lại',
                            'error'
                        );
                    }
                });
            }
        })
    };

    var dataConsultant;
    async function getDetailConsultantByBookingId(id) {
        $("#modal-export-consultant").modal('show');
        $("#modal-id-consultant").modal('hide');
        var data;
        await $.ajax({
            url: systemURL + "consultant/api/Consultant/" + id,
            method: "GET",
            success: function(responseData) {
                data = responseData.data[0];
                dataConsultant = data;
                console.log(data)
                if (data != null) {
                    $("#full-name").text(data.accountName);
                    $("#dob").text(moment(data.dob).format("DD/MM/YYYY"));
                    $("#gender").text(data.gender = 'MALE' ? 'Nam' : 'Nữ');
                    $("#religiousNation").text(data.religiousNation);
                    $("#culturalLevel").text(data.culturalLevel);
                    $("#phone-number").text(data.phone);
                    $("#address-detail").text(data.address);
                    $("#consultingTime").text(data.consultingTime);
                    $("#booking-type").text(data.bookingTypeName);
                    $("#conselor-name").text(data.counselorName);
                    $("#booking-reason").text(data.reason);
                    $("#symptom-user").text(data.symptom);
                    $("#religiorelationship").text(data.religiorelationship);
                    $("#history").text(data.history);
                    $("#assessmentResult").text(data.assessmentResult);
                    $("#target").text(data.target);
                    $("#consultingResults").text(data.consultingResults);
                    $("#consultingPlan").text(data.consultingPlan);
                    $("#review").text(data.review);
                    $('.my-rating').starRating('setRating', data.rating)
                    if (data.rating != null && data.accountId != accountId && data.rating != 0) {
                        $("#btnSave").hide();
                    }
                }
                else {
                    $("#note").removeClass('d-none');
                    $("#btnSave").hide();
                }
            },
            error: function(e) {
            },
        });
        return data;
    }


</script>
